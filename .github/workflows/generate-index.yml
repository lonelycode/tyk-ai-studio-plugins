name: Generate Plugin Index

on:
  push:
    branches:
      - main
    paths:
      - 'plugins/**/manifest.yaml'
  workflow_dispatch:

jobs:
  generate-index:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install PyYAML
        run: pip install pyyaml

      - name: Generate index.yaml
        run: |
          python3 << 'EOF'
          import yaml
          import os
          import re
          from datetime import datetime, timezone
          from pathlib import Path

          # Initialize index structure
          index = {
              'apiVersion': 'v1',
              'generated': datetime.now(timezone.utc).strftime('%Y-%m-%dT%H:%M:%SZ'),
              'plugins': {}
          }

          plugins_dir = Path('plugins')

          # Find all manifest.yaml files
          # Supports two structures:
          #   1. plugins/<plugin-name>/manifest.yaml (legacy, single version)
          #   2. plugins/<plugin-name>/<version>/manifest.yaml (versioned)
          for manifest_path in plugins_dir.glob('**/manifest.yaml'):
              # Skip if more than 2 levels deep (plugin-name/version/manifest.yaml is max)
              relative_parts = manifest_path.relative_to(plugins_dir).parts
              if len(relative_parts) > 3:
                  print(f"Warning: Skipping {manifest_path} - too deeply nested")
                  continue

              with open(manifest_path, 'r') as f:
                  manifest = yaml.safe_load(f)

              plugin_id = manifest.get('id')
              if not plugin_id:
                  print(f"Warning: {manifest_path} missing 'id' field")
                  continue

              # Create indexed plugin entry
              indexed_plugin = {
                  'id': plugin_id,
                  'name': manifest.get('name', ''),
                  'version': manifest.get('version', ''),
                  'description': manifest.get('description', ''),
                  'oci_registry': manifest.get('oci', {}).get('registry', ''),
                  'oci_repository': manifest.get('oci', {}).get('repository', ''),
                  'oci_tag': manifest.get('oci', {}).get('tag', ''),
                  'oci_digest': manifest.get('oci', {}).get('digest', ''),
                  'oci_platform': manifest.get('oci', {}).get('platform', []),
                  'category': manifest.get('category', ''),
                  'maturity': manifest.get('maturity', ''),
                  'publisher': manifest.get('publisher', ''),
                  'license': manifest.get('license', ''),
                  'icon': manifest.get('icon', ''),
                  'primary_hook': manifest.get('capabilities', {}).get('primary_hook', ''),
                  'hooks': manifest.get('capabilities', {}).get('hooks', []),
                  'min_studio_version': manifest.get('requirements', {}).get('min_studio_version', ''),
                  'keywords': manifest.get('keywords', []),
                  'created_at': manifest.get('created_at', ''),
                  'updated_at': manifest.get('updated_at', ''),
                  'deprecated': manifest.get('deprecated', False),
                  'deprecated_message': manifest.get('deprecated_message', ''),
                  'replacement': manifest.get('replacement', ''),
                  'enterprise_only': manifest.get('enterprise_only', False),
                  'manifest_url': f"https://raw.githubusercontent.com/TykTechnologies/tyk-ai-studio-plugins-ce/main/{manifest_path}",
                  'documentation_url': manifest.get('links', {}).get('documentation', ''),
                  'repository_url': manifest.get('links', {}).get('repository', ''),
                  'support_url': manifest.get('links', {}).get('support', ''),
                  'homepage_url': manifest.get('links', {}).get('homepage', ''),
                  'issues_url': manifest.get('links', {}).get('issues', ''),
                  'screenshots': manifest.get('screenshots', []),
                  'api_versions': manifest.get('requirements', {}).get('api_versions', []),
                  'dependencies': manifest.get('requirements', {}).get('dependencies', []),
                  'required_services': manifest.get('permissions', {}).get('services', []),
                  'required_kv': manifest.get('permissions', {}).get('kv', []),
                  'required_rpc': manifest.get('permissions', {}).get('rpc', []),
                  'required_ui': manifest.get('permissions', {}).get('ui', [])
              }

              # Group by plugin ID, supporting multiple versions
              if plugin_id not in index['plugins']:
                  index['plugins'][plugin_id] = []

              index['plugins'][plugin_id].append(indexed_plugin)

          # Sort versions for each plugin using semver (newest first)
          def parse_semver(version_str):
              """Parse semver string into tuple for sorting."""
              match = re.match(r'^(\d+)\.(\d+)\.(\d+)', version_str or '0.0.0')
              if match:
                  return (int(match.group(1)), int(match.group(2)), int(match.group(3)))
              return (0, 0, 0)

          for plugin_id in index['plugins']:
              index['plugins'][plugin_id].sort(
                  key=lambda x: parse_semver(x.get('version', '0.0.0')),
                  reverse=True
              )

          # Write index.yaml
          with open('index.yaml', 'w') as f:
              yaml.dump(index, f, default_flow_style=False, sort_keys=False)

          # Summary
          total_versions = sum(len(versions) for versions in index['plugins'].values())
          print(f"Generated index.yaml with {len(index['plugins'])} plugins ({total_versions} total versions)")
          EOF

      - name: Commit and push if changed
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add index.yaml
          if git diff --staged --quiet; then
            echo "No changes to index.yaml"
          else
            git commit -m "Auto-generate index.yaml from plugin manifests"
            git push
          fi
